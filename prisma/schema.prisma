// This is your Prisma schema file.
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// --- 1. ENUMS (Used across multiple models) ---

enum UserRole {
  CLIENT
  VENDOR
}

enum KycStatus {
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
}

enum OrderStatus {
  ACTIVE // Payment made, event upcoming
  COMPLETED // Event finished, payment clearing
  CANCELLED
  IN_DISPUTE
}

enum QuoteStatus {
  PENDING // Vendor sent, client needs to review
  ACCEPTED // Client accepted, ready for payment
  REJECTED
  REVISION_REQUESTED
}

enum TransactionType {
  PAYMENT // Client pays for an order
  PAYOUT // Vendor withdraws funds
  REFUND
  GIFT // Client receives wallet funds
  SERVICE_FEE
  TOPUP // User adds funds to their wallet
  TRANSFER // Direct user-to-user transfer
  ISAVE_DEPOSIT // Deposit into iSave plan
  ISAVE_WITHDRAWAL // Withdrawal from iSave plan (break or complete)
}

enum NotificationType {
  NEW_MESSAGE
  ORDER_UPDATE
  WISHLIST_CONTRIBUTION
  QUOTE_PAYMENT_RECEIVED
  EVENT_INVITATION
  QUOTE_RECEIVED
  ORDER_COMPLETED
  PAYMENT_REQUEST
}

enum ContributionType {
  PROMISE
  CASH
}

enum GuestStatus {
  PENDING
  ATTENDING
  MAYBE
  DECLINED
}

enum WishlistItemType {
  CASH_REQUEST
  ITEM_REQUEST
}

enum BoardPostType {
  NOTE
  IMAGE
}

enum SavePlanFrequency {
  DAILY
  WEEKLY
  MONTHLY
  MANUAL
}

enum SavePlanStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

// --- 2. AUTH & USER MODELS ---

model User {
  id       String   @id @default(uuid()) // Links to auth.users.id
  email    String   @unique
  username String   @unique
  role     UserRole // Set at sign-up (CLIENT or VENDOR)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // --- Relations ---
  clientProfile      ClientProfile?      // One-to-one
  vendorProfile      VendorProfile?      // One-to-one
  wallet             Wallet?             // One-to-one
  chatSettings       ChatSettings?       // One-to-one
  participations     ConversationParticipant[]
  messages           Message[]           @relation("Sender")
  clientQuotes       Quote[]             @relation("ClientQuotes")
  vendorQuotes       Quote[]             @relation("VendorQuotes")
  clientEventInvitations EventInvitation[] @relation("ClientEventInvitations")
  vendorEventInvitations EventInvitation[] @relation("VendorEventInvitations")
  clientOrders       Order[]             @relation("ClientOrders")
  vendorOrders       Order[]             @relation("VendorOrders")
  hiredGigs          EventVendor[]       @relation("HiredVendor")
  authoredReviews    Review[]            @relation("AuthoredReviews")
  receivedReviews    Review[]            @relation("ReceivedReviews")
  guestContributions WishlistContribution[] @relation("GuestContributions")
  notifications      Notification[]
  posts              Post[]              @relation("Author")
  postLikes          PostLike[]
  postComments       PostComment[]
  postBookmarks      PostBookmark[]
  boardPosts         BoardPost[]
  savePlans          SavePlan[]
  
  blockedUsers       Block[]             @relation("Blocker")
  blockedBy          Block[]             @relation("Blocked")
  messageDeletions   MessageDeletion[]
}

model ClientProfile {
  id        String @id @default(uuid())
  user      User   @relation(fields: [userId], references: [id])
  userId    String @unique // One-to-one
  name      String?
  avatarUrl String?
  bannerUrl String?
  bio       String? @db.Text
  location  Json?
  events    ClientEvent[] @relation("EventOwner")
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

model VendorProfile {
  id                 String              @id @default(uuid())
  user               User                @relation(fields: [userId], references: [id])
  userId             String              @unique // One-to-one
  companyName        String?
  title              String?
  avatarUrl          String?
  bannerUrl          String?
  about              String?             @db.Text
  skills             String[]
  location           Json?
  languages          String[]
  level              String?             @default("Level 0")
  rating             Float               @default(0)
  avgResponseTime    String?             @default("N/A")
  kycStatus          KycStatus           @default(PENDING)
  fullName           String?
  meansOfId          String?
  idNumber           String?
  idCardUrl          String?
  cacNumber          String?
  cacDocumentUrl     String?
  businessAddress    String?
  state              String?
  lga                String?
  subscriptionStatus String              @default("INACTIVE")
  services           ServicesOnVendors[]
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
}

model ChatSettings {
  id                 String   @id @default(uuid())
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId             String   @unique
  readReceipts       Boolean  @default(true)
  typingIndicators   Boolean  @default(true)
  muteAll            Boolean  @default(false)
  soundEnabled       Boolean  @default(true)
  vibrationEnabled   Boolean  @default(true)
  emailNotifications Boolean  @default(true)
  theme              String   @default("light") // light, dark, system
  updatedAt          DateTime @updatedAt
}

model Block {
  id        String   @id @default(uuid())
  blocker   User     @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blockerId String
  blocked   User     @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)
  blockedId String
  createdAt DateTime @default(now())

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
}


// --- 3. GIG & CATEGORY MODELS ---

model Category {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  slug     String?   @unique
  services Service[]
}

model Service {
  id         Int                 @id @default(autoincrement())
  name       String              @unique
  slug       String              @unique
  category   Category            @relation(fields: [categoryId], references: [id])
  categoryId Int
  vendors    ServicesOnVendors[]
}

model ServicesOnVendors {
  vendorProfile   VendorProfile @relation(fields: [vendorProfileId], references: [id])
  vendorProfileId String
  service         Service       @relation(fields: [serviceId], references: [id])
  serviceId       Int
  createdAt       DateTime      @default(now())

  @@id([vendorProfileId, serviceId])
}


// --- 4. EVENT & WISHLIST MODELS (Client-side) ---

model ClientEvent {
  id              String           @id @default(uuid())
  title           String
  date            DateTime
  coverImage      String?
  isPublic        Boolean          @default(false)
  location        Json?
  client          ClientProfile    @relation("EventOwner", fields: [clientProfileId], references: [id])
  clientProfileId String
  hiredVendors    EventVendor[]    @relation("Event")
  invitations     EventInvitation[]
  wishlist        Wishlist?
  conversation    Conversation?    @relation("EventConversation")
  personalTodos   EventPersonalTodo[]
  budget          EventBudget?
  guestLists      EventGuestList[]
  boardPosts      BoardPost[]
}

model EventPersonalTodo {
  id          String    @id @default(uuid())
  content     String
  dueDate     DateTime?
  isCompleted Boolean   @default(false)
  event       ClientEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId     String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([eventId])
}

model EventVendor {
  id        String      @id @default(uuid())
  event     ClientEvent @relation("Event", fields: [eventId], references: [id], onDelete: Cascade)
  eventId   String
  vendor    User        @relation("HiredVendor", fields: [vendorId], references: [id], onDelete: Cascade)
  vendorId  String
  createdAt DateTime    @default(now())

  @@unique([eventId, vendorId])
}

model Wishlist {
  id            String       @id @default(uuid())
  event         ClientEvent  @relation(fields: [clientEventId], references: [id], onDelete: Cascade)
  clientEventId String       @unique
  items         WishlistItem[]
}

model WishlistItem {
  id              String             @id @default(uuid())
  name            String
  itemType        WishlistItemType   @default(ITEM_REQUEST)
  requestedAmount Float?
  imageUrl        String?
  isFulfilled     Boolean            @default(false)
  wishlist        Wishlist           @relation(fields: [wishlistId], references: [id], onDelete: Cascade)
  wishlistId      String
  contributions   WishlistContribution[]
}

model WishlistContribution {
  id             String         @id @default(uuid())
  item           WishlistItem   @relation(fields: [wishlistItemId], references: [id], onDelete: Cascade)
  wishlistItemId String
  type           ContributionType
  amount         Float?
  guestUser      User?          @relation("GuestContributions", fields: [guestUserId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  guestUserId    String?
  guestName      String
  createdAt      DateTime       @default(now())
}


// --- 5. CHAT, QUOTE & ORDER FLOW ---

model Conversation {
  id                     String              @id @default(uuid())
  participants           ConversationParticipant[]
  messages               Message[]
  quotes                 Quote[]
  eventInvitations       EventInvitation[]
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  notifications          Notification[]
  isGroup                Boolean             @default(false)
  groupAdminId           String?
  clientEvent            ClientEvent?        @relation("EventConversation", fields: [clientEventId], references: [id], onDelete: Cascade)
  clientEventId          String?             @unique
}

model ConversationParticipant {
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  lastReadAt     DateTime?
  
  // New chat features
  isPinned       Boolean      @default(false)
  isArchived     Boolean      @default(false)
  isMuted        Boolean      @default(false)
  clearedAt      DateTime?    // If set, messages before this date are hidden for this user (Delete Conversation view)

  @@id([userId, conversationId])
}

model Message {
  id                     String              @id @default(uuid())
  text                   String              @db.Text
  conversation           Conversation        @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId         String
  sender                 User                @relation("Sender", fields: [senderId], references: [id])
  senderId               String
  quote                  Quote?
  eventInvitation        EventInvitation?
  createdAt              DateTime            @default(now())
  
  // New chat features
  isDeletedForEveryone   Boolean             @default(false)
  deletions              MessageDeletion[]
}

model MessageDeletion {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId String
  createdAt DateTime @default(now())

  @@unique([userId, messageId])
  @@index([userId])
  @@index([messageId])
}

model Quote {
  id             String       @id @default(uuid())
  vendor         User         @relation("VendorQuotes", fields: [vendorId], references: [id])
  vendorId       String
  client         User         @relation("ClientQuotes", fields: [clientId], references: [id])
  clientId       String
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  conversationId String
  title          String
  price          Float
  eventDate      DateTime
  includes       String[]
  services       Json
  status         QuoteStatus  @default(PENDING)
  message        Message?     @relation(fields: [messageId], references: [id], onDelete: SetNull)
  messageId      String?      @unique
  order          Order?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model EventInvitation {
  id             String       @id @default(uuid())
  vendor         User         @relation("VendorEventInvitations", fields: [vendorId], references: [id])
  vendorId       String
  client         User         @relation("ClientEventInvitations", fields: [clientId], references: [id])
  clientId       String
  event          ClientEvent  @relation(fields: [eventId], references: [id])
  eventId        String
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  conversationId String
  status         QuoteStatus  @default(PENDING)
  message        Message?     @relation(fields: [messageId], references: [id], onDelete: SetNull)
  messageId      String?      @unique
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model Order {
  id            String          @id @default(uuid())
  vendor        User            @relation("VendorOrders", fields: [vendorId], references: [id])
  vendorId      String
  client        User            @relation("ClientOrders", fields: [clientId], references: [id])
  clientId      String
  quote         Quote           @relation(fields: [quoteId], references: [id])
  quoteId       String          @unique
  amount        Float
  status        OrderStatus     @default(ACTIVE)
  eventDate     DateTime
  review        Review?
  transactions  Transaction[]
  notifications Notification[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}


// --- 6. PAYMENTS & REVIEWS ---

model Wallet {
  id                 String        @id @default(uuid())
  user               User          @relation(fields: [userId], references: [id])
  userId             String        @unique
  availableBalance   Float         @default(0)
  clearingBalance    Float         @default(0)
  activeOrderBalance Float         @default(0)
  totalExpenses      Float         @default(0)
  totalEarnings      Float         @default(0)
  transactions       Transaction[]
  updatedAt          DateTime      @updatedAt
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  HELD
}

model Transaction {
  id          String            @id @default(uuid())
  wallet      Wallet            @relation(fields: [walletId], references: [id])
  walletId    String
  type        TransactionType
  amount      Float
  status      TransactionStatus
  order       Order?            @relation(fields: [orderId], references: [id])
  orderId     String?
  savePlan    SavePlan?         @relation(fields: [savePlanId], references: [id])
  savePlanId  String?
  description String
  createdAt   DateTime          @default(now())
}

model Review {
  id        String   @id @default(uuid())
  order     Order    @relation(fields: [orderId], references: [id])
  orderId   String   @unique
  rating    Int
  comment   String   @db.Text
  author    User     @relation("AuthoredReviews", fields: [authorId], references: [id])
  authorId  String
  subject   User     @relation("ReceivedReviews", fields: [subjectId], references: [id])
  subjectId String
  createdAt DateTime @default(now())
}

// --- 7. NOTIFICATIONS ---

model Notification {
  id             String        @id @default(uuid())
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  type           NotificationType
  message        String
  link           String?
  read           Boolean       @default(false)
  createdAt      DateTime      @default(now())
  conversation   Conversation? @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId String?
  order          Order?        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId        String?
}

// --- 8. GALLERY / POST MODELS ---

enum AssetType {
  IMAGE
  VIDEO
}

model Post {
  id        String   @id @default(uuid())
  caption   String?  @db.Text
  author    User     @relation("Author", fields: [authorId], references: [id], onDelete: Cascade)
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assets    PostAsset[]
  likes     PostLike[]
  comments  PostComment[]
  bookmarks PostBookmark[]

  @@index([authorId])
}

model PostAsset {
  id     String    @id @default(uuid())
  post   Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId String
  url    String
  type   AssetType
  order  Int

  @@index([postId])
}

model PostLike {
  id     String   @id @default(uuid())
  post   Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId String
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  createdAt DateTime @default(now())

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model PostComment {
  id        String        @id @default(uuid())
  post      Post          @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String
  author    User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId  String
  text      String        @db.Text
  createdAt DateTime      @default(now())
  parent    PostComment?  @relation("Replies", fields: [parentId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  parentId  String?
  replies   PostComment[] @relation("Replies")

  @@index([postId])
  @@index([authorId])
  @@index([parentId])
}

model PostBookmark {
  id     String   @id @default(uuid())
  post   Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId String
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  createdAt DateTime @default(now())

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

// --- 9. EVENT MANAGEMENT MODELS ---

model BoardPost {
  id          String        @id @default(uuid())
  type        BoardPostType
  content     String        @db.Text
  author      User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId    String
  authorName  String
  rotation    Float
  colorIndex  Int
  x           Float
  y           Float
  zIndex      Int
  event       ClientEvent   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId     String
  createdAt   DateTime      @default(now())

  @@index([eventId])
}

model EventBudget {
  id      String            @id @default(uuid())
  event   ClientEvent       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId String            @unique
  items   EventBudgetItem[]
}

model EventBudgetItem {
  id            String      @id @default(uuid())
  description   String
  estimatedCost Float
  actualCost    Float?
  budget        EventBudget @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  budgetId      String
  createdAt     DateTime    @default(now())

  @@index([budgetId])
}

model EventGuestList {
  id      String       @id @default(uuid())
  title   String
  event   ClientEvent  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId String
  guests  EventGuest[]

  @@index([eventId])
}

model EventGuest {
  id     String         @id @default(uuid())
  name   String
  email  String?
  status GuestStatus    @default(PENDING)
  tableNumber Int?
  invitationToken String? @unique
  list   EventGuestList @relation(fields: [listId], references: [id], onDelete: Cascade)
  listId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([listId])
}

// --- 10. iSave (Savings) MODELS ---

model SavePlan {
  id                String            @id @default(uuid())
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId            String
  title             String
  description       String?
  targetAmount      Float
  currentAmount     Float             @default(0)
  frequency         SavePlanFrequency @default(MANUAL)
  autoSaveAmount    Float?            // Amount to deduct if frequency is automated
  targetDate        DateTime
  startDate         DateTime          @default(now())
  nextDeductionDate DateTime?
  status            SavePlanStatus    @default(ACTIVE)
  transactions      Transaction[]
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([userId])
}
